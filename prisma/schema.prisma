// WorkZen HRMS - Prisma Schema
// Database: MySQL with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  ADMIN
  HR_OFFICER
  PAYROLL_OFFICER
  EMPLOYEE
}

enum LeaveType {
  SICK
  CASUAL
  PAID
  UNPAID
  MATERNITY
  PATERNITY
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum PayrunStatus {
  DRAFT
  PROCESSING
  FINALIZED
  PAID
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  LEAVE
  HOLIDAY
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // bcrypt hashed
  role      Role     @default(EMPLOYEE)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employee  Employee?
  auditLogs AuditLog[]

  @@index([email])
  @@map("users")
}

// ============================================
// EMPLOYEE
// ============================================

model Employee {
  id              String    @id @default(uuid())
  userId          String    @unique
  firstName       String
  lastName        String
  dateOfBirth     DateTime?
  dateOfJoining   DateTime
  department      String?
  designation     String?
  phoneNumber     String?
  address         String?   @db.Text
  emergencyContact String?
  bankAccountNo   String?
  ifscCode        String?
  panNumber       String?
  aadharNumber    String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  attendances     Attendance[]
  leaves          Leave[]
  salaryStructure SalaryStructure?
  payslips        Payslip[]

  @@index([userId])
  @@index([department])
  @@map("employees")
}

// ============================================
// ATTENDANCE
// ============================================

model Attendance {
  id          String           @id @default(uuid())
  employeeId  String
  date        DateTime         @db.Date
  checkIn     DateTime?
  checkOut    DateTime?
  status      AttendanceStatus @default(PRESENT)
  workingHours Float           @default(0) // in hours
  remarks     String?          @db.Text
  isManual    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  employee    Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
  @@map("attendance")
}

// ============================================
// LEAVE (TIME-OFF)
// ============================================

model Leave {
  id          String      @id @default(uuid())
  employeeId  String
  leaveType   LeaveType
  startDate   DateTime    @db.Date
  endDate     DateTime    @db.Date
  totalDays   Float       // supports half-day (0.5)
  reason      String      @db.Text
  status      LeaveStatus @default(PENDING)
  approvedBy  String?
  approvedAt  DateTime?
  rejectedBy  String?
  rejectedAt  DateTime?
  cancelledAt DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  employee    Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([status])
  @@index([startDate])
  @@map("leaves")
}

// ============================================
// SALARY STRUCTURE
// ============================================

model SalaryStructure {
  id             String   @id @default(uuid())
  employeeId     String   @unique
  basicSalary    Float    // base pay
  hra            Float    @default(0) // House Rent Allowance
  allowances     Float    @default(0) // Other allowances
  deductions     Float    @default(0) // Fixed deductions
  pfContribution Float    @default(0) // Provident Fund (12% of basic)
  effectiveFrom  DateTime @db.Date
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  employee       Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@map("salary_structures")
}

// ============================================
// PAYRUN (Monthly Payroll Processing)
// ============================================

model Payrun {
  id          String        @id @default(uuid())
  month       Int           // 1-12
  year        Int
  status      PayrunStatus  @default(DRAFT)
  totalGross  Float         @default(0)
  totalNet    Float         @default(0)
  processedBy String?
  processedAt DateTime?
  finalizedBy String?
  finalizedAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  payslips    Payslip[]

  @@unique([month, year])
  @@index([status])
  @@map("payruns")
}

// ============================================
// PAYSLIP
// ============================================

model Payslip {
  id                  String   @id @default(uuid())
  payrunId            String
  employeeId          String
  month               Int
  year                Int
  basicSalary         Float
  hra                 Float
  allowances          Float
  grossSalary         Float    // basic + hra + allowances
  pfDeduction         Float    // 12% of basic
  professionalTax     Float    @default(0)
  unpaidDeduction     Float    @default(0) // based on leaves/absences
  otherDeductions     Float    @default(0)
  totalDeductions     Float
  netSalary           Float    // gross - totalDeductions
  payableDays         Float    // working days - unpaid leaves
  totalDays           Float    // total days in month
  leaveDays           Float    @default(0)
  pdfUrl              String?  @db.Text
  emailSent           Boolean  @default(false)
  emailSentAt         DateTime?
  isEditable          Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  payrun              Payrun   @relation(fields: [payrunId], references: [id], onDelete: Cascade)
  employee            Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([payrunId, employeeId])
  @@index([employeeId])
  @@index([payrunId])
  @@map("payslips")
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id          String   @id @default(uuid())
  userId      String
  action      String   // e.g., "USER_CREATED", "PAYROLL_FINALIZED"
  entity      String   // e.g., "User", "Payslip"
  entityId    String
  changes     String?  @db.Text // JSON stringified changes
  ipAddress   String?
  userAgent   String?  @db.Text
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// SETTINGS (Global Configuration)
// ============================================

model Settings {
  id                    String   @id @default(uuid())
  key                   String   @unique
  value                 String   @db.Text
  description           String?  @db.Text
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("settings")
}
