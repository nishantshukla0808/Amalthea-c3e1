// WorkZen HRMS - Prisma Schema
// Database: MySQL with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  ADMIN
  HR_OFFICER
  PAYROLL_OFFICER
  EMPLOYEE
}

enum LeaveType {
  SICK
  CASUAL
  PAID
  UNPAID
  MATERNITY
  PATERNITY
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum PayrunStatus {
  DRAFT        // Initial state, can create/edit payslips
  PROCESSING   // Calculating payslips
  VALIDATED    // Finalized/"Done" - locked, ready for payment
  PAID         // Payment completed
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  LEAVE
  HOLIDAY
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id                    String   @id @default(uuid())
  loginId               String   @unique // Auto-generated: OIJODO20220001
  email                 String   @unique
  password              String   // bcrypt hashed
  role                  Role     @default(EMPLOYEE)
  isActive              Boolean  @default(true)
  mustChangePassword    Boolean  @default(true) // Force password change on first login
  lastPasswordChange    DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  employee  Employee?
  auditLogs AuditLog[]

  @@index([email])
  @@index([loginId])
  @@map("users")
}

// ============================================
// EMPLOYEE
// ============================================

model Employee {
  id              String    @id @default(uuid())
  userId          String    @unique
  employeeId      String    @unique // Same as User.loginId for reference
  firstName       String
  lastName        String
  dateOfBirth     DateTime?
  dateOfJoining   DateTime
  joiningYear     Int       // Year of joining (extracted from dateOfJoining)
  department      String?
  designation     String?
  phoneNumber     String?
  address         String?   @db.Text
  emergencyContact String?
  bankAccountNo   String?
  ifscCode        String?
  panNumber       String?
  aadharNumber    String?
  uanNumber       String?   // Universal Account Number for PF
  location        String?   // Employee location/branch
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  attendances     Attendance[]
  leaves          Leave[]
  salaryStructure SalaryStructure?
  payslips        Payslip[]

  @@index([userId])
  @@index([employeeId])
  @@index([department])
  @@index([joiningYear])
  @@map("employees")
}

// ============================================
// ATTENDANCE
// ============================================

model Attendance {
  id          String           @id @default(uuid())
  employeeId  String
  date        DateTime         @db.Date
  checkIn     DateTime?
  checkOut    DateTime?
  breakTime   Float?           // Break time in hours (calculated)
  actualHours Float?           // Actual hours worked (checkOut - checkIn - breakTime)
  status      AttendanceStatus @default(PRESENT)
  workingHours Float           @default(0) // Standard working hours (8 hours)
  remarks     String?          @db.Text
  isManual    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  employee    Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
  @@map("attendance")
}

// ============================================
// LEAVE (TIME-OFF)
// ============================================

model Leave {
  id          String      @id @default(uuid())
  employeeId  String
  leaveType   LeaveType
  startDate   DateTime    @db.Date
  endDate     DateTime    @db.Date
  totalDays   Float       // supports half-day (0.5)
  reason      String      @db.Text
  status      LeaveStatus @default(PENDING)
  approvedBy  String?
  approvedAt  DateTime?
  rejectedBy  String?
  rejectedAt  DateTime?
  cancelledAt DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  employee    Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([status])
  @@index([startDate])
  @@map("leaves")
}

// ============================================
// SALARY STRUCTURE
// ============================================

model SalaryStructure {
  id                      String   @id @default(uuid())
  employeeId              String   @unique
  
  // Wage (Employer Cost)
  monthlyWage             Float    // ₹50,000 - Total cost to company
  
  // Salary Components (calculated amounts)
  basicSalary             Float    // ₹25,000
  hra                     Float    // ₹12,500 - House Rent Allowance
  standardAllowance       Float    // ₹4,167 - Fixed amount
  performanceBonus        Float    // ₹2,082.50
  leaveTravelAllowance    Float    // ₹2,082.50
  fixedAllowance          Float    // Auto-calculated (remaining amount)
  
  // Computation Percentages
  basicPercentage         Float    @default(50.0)   // 50% of wage
  hraPercentage           Float    @default(50.0)   // 50% of basic
  performanceBonusPercent Float    @default(8.33)   // 8.33% of basic
  ltaPercentage           Float    @default(8.33)   // 8.33% of basic
  
  // Deduction Settings
  pfPercentage            Float    @default(12.0)   // 12% of basic (both employee & employer)
  professionalTax         Float    @default(200.0)  // Fixed ₹200/month
  
  // Working Schedule
  workingDaysPerWeek      Int      @default(5)      // Monday-Friday
  workingHoursPerDay      Float    @default(8.0)    // 8 hours/day
  
  effectiveFrom           DateTime @db.Date
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  employee                Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@map("salary_structures")
}

// ============================================
// PAYRUN (Monthly Payroll Processing)
// ============================================

model Payrun {
  id                String        @id @default(uuid())
  month             Int           // 1-12
  year              Int
  payPeriodStart    DateTime      @db.Date  // Pay period start date (e.g., 2025-01-01)
  payPeriodEnd      DateTime      @db.Date  // Pay period end date (e.g., 2025-01-31)
  payDate           DateTime?     @db.Date  // Actual payment date
  status            PayrunStatus  @default(DRAFT)
  
  // Summary Statistics
  employeeCount     Int           @default(0)   // Number of employees in this payrun
  totalEmployerCost Float         @default(0)   // Total employer cost (sum of wages)
  totalBasicWage    Float         @default(0)   // Total basic salaries
  totalGrossWage    Float         @default(0)   // Total gross wages
  totalNetWage      Float         @default(0)   // Total net wages
  
  // Warnings/Validation Issues
  warnings          String?       @db.Text      // JSON array of validation warnings
  
  // Audit Trail
  processedBy       String?       // User ID who processed
  processedAt       DateTime?     // When payslips were calculated
  validatedBy       String?       // User ID who validated/finalized
  validatedAt       DateTime?     // When payrun was validated
  paidBy            String?       // User ID who marked as paid
  paidAt            DateTime?     // When marked as paid
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  payslips          Payslip[]

  @@unique([month, year])
  @@index([status])
  @@index([year, month])
  @@map("payruns")
}

// ============================================
// PAYSLIP
// ============================================

model Payslip {
  id                    String    @id @default(uuid())
  payrunId              String
  employeeId            String
  
  // Period Information
  month                 Int
  year                  Int
  payPeriodStart        DateTime  @db.Date  // Pay period start
  payPeriodEnd          DateTime  @db.Date  // Pay period end
  payDate               DateTime? @db.Date  // Payment date
  
  // Employee Information Snapshot (at time of payslip generation)
  employeeName          String
  employeeCode          String
  department            String?
  designation           String?
  location              String?
  panNumber             String?
  uanNumber             String?
  bankAccountNo         String?
  ifscCode              String?
  dateOfJoining         DateTime? @db.Date
  
  // Earnings (All salary components)
  basicSalary           Float     // Basic salary amount
  hra                   Float     // House Rent Allowance
  standardAllowance     Float     // Standard allowance (fixed ₹4167)
  performanceBonus      Float     // Performance bonus
  leaveTravelAllowance  Float     // LTA
  fixedAllowance        Float     // Fixed allowance (balance)
  grossSalary           Float     // Total of all earnings
  
  // Deductions
  pfEmployee            Float     // Employee PF contribution (12% of basic)
  pfEmployer            Float     // Employer PF contribution (12% of basic)
  professionalTax       Float     // Professional tax (₹200)
  tdsDeduction          Float     @default(0)  // TDS deduction (manual)
  unpaidDeduction       Float     @default(0)  // Unpaid leaves/absences deduction
  otherDeductions       Float     @default(0)  // Other manual deductions
  totalDeductions       Float     // Total of all deductions
  
  // Net Salary
  netSalary             Float     // Gross - Total Deductions
  netSalaryWords        String?   @db.Text  // Amount in words (English)
  
  // Days Breakdown
  totalDaysInMonth      Int       // Total calendar days (30/31)
  workingDaysInMonth    Int       // Working days excluding weekends (~22)
  attendanceDays        Float     @default(0)  // Actual attendance days
  paidLeaveDays         Float     @default(0)  // Paid leaves taken
  unpaidLeaveDays       Float     @default(0)  // Unpaid leaves taken
  absentDays            Float     @default(0)  // Absent without leave
  holidayDays           Float     @default(0)  // Holidays (paid)
  workedDays            Float     @default(0)  // Total worked days (attendance + paid leaves)
  payableDays           Float     @default(0)  // Days for which salary is paid
  
  // Rate/Percentage
  ratePercentage        Float     @default(100)  // (payableDays / totalDays) × 100
  
  // Status & Flags
  status                String    @default("DRAFT")  // DRAFT, VALIDATED, PAID
  isEditable            Boolean   @default(true)
  
  // PDF & Email
  pdfUrl                String?   @db.Text
  pdfGenerated          Boolean   @default(false)
  emailSent             Boolean   @default(false)
  emailSentAt           DateTime?
  
  // Audit
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  payrun                Payrun    @relation(fields: [payrunId], references: [id], onDelete: Cascade)
  employee              Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([payrunId, employeeId])
  @@index([employeeId])
  @@index([payrunId])
  @@index([status])
  @@index([year, month])
  @@map("payslips")
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id          String   @id @default(uuid())
  userId      String
  action      String   // e.g., "USER_CREATED", "PAYROLL_FINALIZED"
  entity      String   // e.g., "User", "Payslip"
  entityId    String
  changes     String?  @db.Text // JSON stringified changes
  ipAddress   String?
  userAgent   String?  @db.Text
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// SETTINGS (Global Configuration)
// ============================================

model Settings {
  id                    String   @id @default(uuid())
  key                   String   @unique
  value                 String   @db.Text
  description           String?  @db.Text
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("settings")
}
